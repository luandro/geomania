name: Update Country Data

on:
  schedule:
    # Weekly refresh (Sunday 03:00 UTC)
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      downloadFlags:
        description: 'Download and refresh local flag assets'
        type: boolean
        default: false
      useCache:
        description: 'Use cached raw data instead of fetching'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update countries data
        run: |
          ARGS=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.downloadFlags }}" = "true" ]; then
            ARGS="$ARGS --download-flags"
          fi
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.useCache }}" = "true" ]; then
            ARGS="$ARGS --use-cache"
          fi
          npm run update:countries -- $ARGS
        env:
          COUNTRY_DATA_USER_AGENT: "geomania-country-data/1.0 (https://github.com/${{ github.repository }})"

      - name: Verify public flags are hashed
        run: npm run verify:public-flags

      - name: Validate generated data
        run: |
          npm run typecheck
          npm run lint

      - name: Disable Git hooks
        run: git config core.hooksPath /dev/null

      - name: Create PR if data changed
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update country data"
          title: "Update country data"
          body: "Automated refresh of `src/data/countries.ts` from external sources."
          branch: "bot/update-country-data"
          delete-branch: true
